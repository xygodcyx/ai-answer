<!-- å‰ç«¯ index.html -->
<!DOCTYPE html>
<html>
  <head>
    <title>AIé—®ç­”æŒ‘æˆ˜</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 100%; /* æ”¹ä¸ºç™¾åˆ†æ¯”å¸ƒå±€ */
        margin: 0 auto;
        padding: 12px; /* å‡å°é»˜è®¤é—´è· */
      }

      .question-box {
        width: 80vw;
        margin: 0 auto;
        background: #f5f5f5;
        padding: 15px;
        height: 60vh;
        border-radius: 8px;
        margin-bottom: 15px;
        position: relative;
      }
      #explanation {
        width: 80vw;
        margin: 0 auto;
      }

      #score {
        position: static; /* æ”¹ä¸ºé™æ€å®šä½ */
        text-align: right;
        font-size: 20px;
        margin-bottom: 15px;
      }

      form {
        gap: 10px;
        height: 60%;
        display: flex;
        flex-direction: column;
      }

      #answerInput {
        min-width: 200px;
        height: 80%;
        padding: 12px;
        font-size: 16px;
      }

      button {
        padding: 12px 18px;
        font-size: 15px;
        white-space: nowrap;
      }

      #voiceBtn {
        margin-left: 0; /* ç§»é™¤å·¦ä¾§é—´è· */
      }

      /* ç§»åŠ¨ç«¯ä¼˜åŒ– */

      @media screen and (max-width: 768px) {
        body {
          padding: 8px;
        }

        .question-box {
          padding: 12px;
          width: 90vw;
          height: 60vh;
          margin: auto 0;
        }

        h2 {
          font-size: 20px; /* å‡å°æ ‡é¢˜å­—å· */
          line-height: 1.3;
        }

        form {
          height: 30%;
        }
        #answerInput {
          width: 100%;
          height: 60%;
          margin-bottom: 8px;
          line-height: 1;
        }

        button {
          width: 100%;
          padding: 10px;
          font-size: 14px;
        }

        #score {
          font-size: 18px;
        }
      }

      /* å¹³æ¿è®¾å¤‡ä¼˜åŒ– */
      @media screen and (min-width: 769px) and (max-width: 1024px) {
        body {
          padding: 15px;
        }

        button {
          padding: 12px 15px;
        }
      }
    </style>
  </head>
  <body>
    <div class="question-box">
      <h2 id="question">æ­£åœ¨åŠ è½½é¢˜ç›®...</h2>
      <div id="score">å¾—åˆ†: 0</div>
      <form>
        <input
          type="text"
          id="answerInput"
          placeholder="ç‚¹å‡»å³ä¾§æŒ‰é’®è¯­éŸ³å›ç­”"
          required
        />
        <button
          id="voiceBtn"
          type="button"
        >
          ğŸ¤
        </button>
        <button
          id="submitBtn"
          type="submit"
        >
          æäº¤ç­”æ¡ˆ
        </button>
        <button
          id="nextQuestion"
          type="button"
        >
          ä¸‹ä¸€é¢˜
        </button>
      </form>
    </div>
    <div id="explanation"></div>

    <script>
      let recognition;
      let currentQuestion = '';
      let score = 0;

      const nextQuestionBtn = document.getElementById('nextQuestion');
      nextQuestionBtn.addEventListener('click', () => {
        fetchNewQuestion();
        nextQuestionBtn.setAttribute('disabled', true);
      });
      nextQuestionBtn.setAttribute('disabled', true);

      document.querySelector('form').addEventListener('submit', (event) => {
        event.preventDefault();
        submitAnswer();
      });
      const explanationEl = document.getElementById('explanation');

      const answerInput = document.getElementById('answerInput');
      const submitBtn = document.getElementById('submitBtn');
      const voiceBtn = document.getElementById('voiceBtn');

      // åˆå§‹åŒ–è¯­éŸ³è¯†åˆ«
      window.onload = function () {
        if ('webkitSpeechRecognition' in window) {
          try {
            recognition = new webkitSpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'zh-CN';

            recognition.onresult = function (event) {
              const transcript = event.results[0][0].transcript;
              console.log('Transcript:', transcript);
              answerInput.value = transcript;
            };

            voiceBtn.onclick = function () {
              recognition.start();
            };
          } catch (e) {
            voiceBtn.setAttribute('disabled', true);
          }
        } else {
          alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«');
        }
        fetchNewQuestion();
      };

      function disableActions() {
        answerInput.setAttribute('disabled', true);
        submitBtn.setAttribute('disabled', true);
        voiceBtn.setAttribute('disabled', true);
        nextQuestionBtn.setAttribute('disabled', true);
      }
      function enableActions() {
        nextQuestionBtn.removeAttribute('disabled');
        voiceBtn.removeAttribute('disabled');
        answerInput.removeAttribute('disabled');
        submitBtn.removeAttribute('disabled');
      }

      // ä¿®æ”¹fetchNewQuestionå‡½æ•°ä¸ºæµå¼æ¥æ”¶
      async function fetchNewQuestion() {
        disableActions();
        document.getElementById('question').textContent = 'æ­£åœ¨è·å–é¢˜ç›®...';
        explanationEl.innerHTML = '';
        currentQuestion = '';
        try {
          const response = await fetch(`http://localhost:3000/new-question`);
          const reader = response.body.getReader();
          const decoder = new TextDecoder();

          document.getElementById('question').textContent = '';
          while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            const textChunk = decoder.decode(value);
            document.getElementById('question').textContent += textChunk;
            currentQuestion += textChunk; // æŒç»­æ„å»ºå®Œæ•´é—®é¢˜
          }
          enableActions();
        } catch (error) {
          document.getElementById('question').textContent = 'è·å–é¢˜ç›®å¤±è´¥';
          console.error('è·å–é¢˜ç›®å¤±è´¥:', error);
        }
      }

      // ä¿®æ”¹submitAnswerå‡½æ•°ä¸ºæµå¼æ¥æ”¶
      async function submitAnswer() {
        const userAnswer = answerInput.value;
        if (!userAnswer) return;

        disableActions();
        // ç­‰å¾…çš„emojoå›¾æ ‡

        explanationEl.innerHTML = `
                <h3>ğŸ¤”æ­£åœ¨éªŒè¯â€¦â€¦</h3>
                <p></p>
              `;

        try {
          const response = await fetch('http://localhost:3000/check-answer', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              question: currentQuestion,
              answer: userAnswer,
            }),
          });

          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let fullResponse = '';
          let isJsonPart = false;
          let jsonBuffer = '';
          while (true) {
            const { done, value } = await reader.read();
            if (done) {
              try {
                console.log('fullResponse:', fullResponse);
                const startIndex = fullResponse.indexOf('{');
                const endIndex = fullResponse.indexOf('}');
                const json = JSON.parse(
                  fullResponse.substring(startIndex, endIndex + 1)
                );
                console.log('json:', json);

                score += json.score;
                document.getElementById('score').textContent = `å¾—åˆ†: ${score}`;
                const h3 = explanationEl.querySelector('h3');
                if (json.correct < 50) {
                  h3.textContent = 'âŒ é”™è¯¯';
                } else if (json.correct < 70) {
                  h3.textContent = 'ğŸ¤” åŸºæœ¬æ­£ç¡®';
                } else if (json.correct < 90) {
                  h3.textContent = 'ğŸ¤— å¾ˆæ£’ï¼';
                } else if (json.correct <= 100) {
                  h3.textContent = 'ğŸ‰ å¤ªæ£’äº†ï¼';
                }
                h3.textContent += ` å¾—åˆ†: ${json.score}`;
              } catch (e) {
                explanationEl.innerHTML = `
                ğŸ™å‡ºé”™äº†â€¦â€¦${e.message}`;
              }
              break;
            }

            const textChunk = decoder.decode(value);
            // const isJsonStart = textChunk.includes('{');

            // å®æ—¶æ˜¾ç¤ºæµå¼å†…å®¹
            fullResponse += textChunk;
            if (fullResponse.includes('{')) isJsonPart = true;
            if (!isJsonPart) {
              explanationEl.innerHTML = `
                <h3>ğŸ¤”æ­£åœ¨éªŒè¯â€¦â€¦</h3>
                <p>${fullResponse}</p>
              `;
            }

            // if (!isJsonPart) {
            // }
            //  else {
            //   jsonBuffer += textChunk;
            //   if (textChunk.includes('}')) {
            //     try {
            //       const result = JSON.parse(jsonBuffer.match(/{[\s\S]*?}/)[0]);
            //       explanationEl.innerHTML = `
            //     <h3>${result.correct ? 'âœ… æ­£ç¡®ï¼' : 'âŒ é”™è¯¯'}</h3>
            //     <p>${result.explanation}</p>
            //   `;
            //       if (result.correct) {
            //         score += 10;
            //         document.getElementById(
            //           'score'
            //         ).textContent = `å¾—åˆ†: ${score}`;
            //       }
            //     } catch (e) {
            //       console.warn('JSONè§£æä¸­:', e);
            //     }
            //     isJsonPart = false;
            //     jsonBuffer = '';
            //   }
            // }
          }
        } catch (error) {
          console.error('æäº¤å¤±è´¥:', error);
        } finally {
          answerInput.value = '';
          enableActions();
        }
      }
    </script>
  </body>
</html>
