<!DOCTYPE html>
<html>
  <head>
    <title>AIé—®ç­”æŒ‘æˆ˜</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      .question-box {
        background: #f5f5f5;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        position: relative;
      }
      #voiceBtn {
        margin-left: 10px;
        cursor: pointer;
      }
      #score {
        position: absolute;
        top: 20px;
        right: -6rem;
        font-size: 24px;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <div class="question-box">
      <h2 id="question">æ­£åœ¨åŠ è½½é¢˜ç›®...</h2>
      <div id="score">å¾—åˆ†: 0</div>
      <form>
        <input
          type="text"
          id="answerInput"
          placeholder="ç‚¹å‡»å³ä¾§æŒ‰é’®è¯­éŸ³å›ç­”"
        />
        <button
          id="voiceBtn"
          type="button"
        >
          ğŸ¤
        </button>
        <button
          onclick="submitAnswer()"
          id="submitBtn"
          type="submit"
        >
          æäº¤ç­”æ¡ˆ
        </button>
        <button
          onclick="fetchNewQuestion()"
          id="nextQuestion"
          type="button"
        >
          ä¸‹ä¸€é¢˜
        </button>
      </form>
    </div>
    <div id="explanation"></div>

    <script>
      let recognition;
      let currentQuestion = '';
      let score = 0;
      let chatHistory = [];

      const nextQuestionBtn = document.getElementById('nextQuestion');
      nextQuestionBtn.addEventListener('click', () => {
        fetchNewQuestion();
        nextQuestionBtn.setAttribute('disabled', true);
      });
      nextQuestionBtn.setAttribute('disabled', true);

      const answerInput = document.getElementById('answerInput');
      const submitBtn = document.getElementById('submitBtn');
      const voiceBtn = document.getElementById('voiceBtn');

      // åˆå§‹åŒ–è¯­éŸ³è¯†åˆ«
      window.onload = function () {
        if ('webkitSpeechRecognition' in window) {
          recognition = new webkitSpeechRecognition();
          recognition.continuous = false;
          recognition.interimResults = false;
          recognition.lang = 'zh-CN';

          recognition.onresult = function (event) {
            const transcript = event.results[0][0].transcript;
            console.log('Transcript:', transcript);
            answerInput.value = transcript;
          };

          voiceBtn.onclick = function () {
            recognition.start();
          };
        } else {
          alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«');
        }
        fetchNewQuestion();
      };

      function disableActions() {
        answerInput.setAttribute('disabled', true);
        submitBtn.setAttribute('disabled', true);
        voiceBtn.setAttribute('disabled', true);
        nextQuestionBtn.setAttribute('disabled', true);
      }
      function enableActions() {
        nextQuestionBtn.removeAttribute('disabled');
        voiceBtn.removeAttribute('disabled');
        answerInput.removeAttribute('disabled');
        submitBtn.removeAttribute('disabled');
      }

      async function fetchNewQuestion() {
        disableActions();
        document.getElementById('question').textContent = 'æ­£åœ¨åŠ è½½é¢˜ç›®...';
        document.getElementById('explanation').innerHTML = '';
        try {
          const response = await fetch(
            `http://localhost:3000/new-question`
          ).finally(() => {
            enableActions();
          });
          const data = await response.json();
          currentQuestion = data.question;
          document.getElementById('question').textContent = data.question;
          chatHistory = data.history;
        } catch (error) {
          document.getElementById('question').textContent = 'è·å–é¢˜ç›®å¤±è´¥';
          document.getElementById('explanation').innerHTML = `
          <h3>å‡ºé”™äº†â€¦â€¦${error.message}</h3>`;
          console.error('è·å–é¢˜ç›®å¤±è´¥:', error);
        }
      }

      async function submitAnswer() {
        const userAnswer = answerInput.value;
        disableActions();
        if (!userAnswer) return;

        try {
          const response = await fetch('http://localhost:3000/check-answer', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              question: currentQuestion,
              answer: userAnswer,
              history: chatHistory,
            }),
          })
            .finally(() => {
              answerInput.value = '';
              enableActions();
            })
            .catch((error) => {
              document.getElementById('question').textContent = 'è·å–é¢˜ç›®å¤±è´¥';
              document.getElementById('explanation').innerHTML = `
                    <h3>å‡ºé”™äº†â€¦â€¦${error.message}</h3>`;
            });

          const result = await response.json();
          document.getElementById('explanation').innerHTML = `
                    <h3>${result.correct ? 'âœ… æ­£ç¡®ï¼' : 'âŒ é”™è¯¯'}</h3>
                    <p>${result.explanation}</p>
                `;

          if (result.correct) {
            score += 10;
            document.getElementById('score').textContent = `å¾—åˆ†: ${score}`;
          }
        } catch (error) {
          console.error('æäº¤å¤±è´¥:', error);
        }
      }
    </script>
  </body>
</html>
